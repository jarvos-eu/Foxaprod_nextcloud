server {
  listen 80 default_server;
  server_name foxaprod.jarvos.eu;
  root /var/www/html;

  # Headers de sécurité
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options SAMEORIGIN always;
  add_header Referrer-Policy no-referrer always;

  # Types MIME
  include /etc/nginx/mime.types;
  include /etc/nginx/mime.types.d/*.types;

  # Fichiers statiques
  location = /robots.txt { allow all; log_not_found off; access_log off; }
  location = /.well-known/carddav { return 301 /remote.php/dav; }
  location = /.well-known/caldav  { return 301 /remote.php/dav; }

  # Empêche l'accès aux fichiers sensibles (sans bloquer apps/)
  location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { deny all; }
  location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console)(?:$|/) { deny all; }
  
  # Configuration spécifique pour les applications Nextcloud
  # Désactive explicitement l'autoindex pour éviter les erreurs 403
  location ~ ^/apps/ {
    autoindex off;
    try_files $uri $uri/ /index.php$request_uri;
  }

  # PHP via FPM - Configuration officielle Nextcloud
  location ~ \.php(?:$|/) {
    fastcgi_split_path_info ^(.+?\.php)(/.*)$;
    fastcgi_pass app:9000;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    include fastcgi_params;
    fastcgi_param modHeadersAvailable true;
    fastcgi_param front_controller_active true;
    fastcgi_read_timeout 300s;
  }

  # Ressources statiques avec cache
  location ~ \.(?:css|js|mjs|woff2?|svg|gif|map)$ {
    try_files $uri /index.php$request_uri;
    expires 6M;
    access_log off;
  }

  # Configuration officielle Nextcloud - GESTION DES DOSSIERS
  # Cette règle doit être en dernier pour gérer tous les cas
  location / {
    try_files $uri $uri/ /index.php$request_uri;
  }
}
