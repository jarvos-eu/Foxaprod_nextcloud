server {
  listen 80 default_server;
  server_name foxaprod.jarvos.eu;

  # Racine pointant vers nc_data monté en RO
  root /var/www/html;

  # --- Sécurité & headers de base (sans dupliquer ceux que Traefik gère) ---
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options SAMEORIGIN always;
  add_header Referrer-Policy no-referrer always;

  # --- Types MIME ---
  include /etc/nginx/mime.types;
  include /etc/nginx/mime.types.d/*.types;

  # Fichiers statiques
  location = /robots.txt { allow all; log_not_found off; access_log off; }
  location = /.well-known/carddav { return 301 /remote.php/dav; }
  location = /.well-known/caldav  { return 301 /remote.php/dav; }

  # Empêche l'accès à ces chemins (CORRIGÉ - supprimé 'apps' de la liste)
  location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ { deny all; }
  location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) { deny all; }

  # PHP via FPM
  location ~ \.php(?:$|/) {
    fastcgi_split_path_info ^(.+?\.php)(/.*)$;
    fastcgi_pass app:9000;   # service FPM
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    include fastcgi_params;

    # Variables Nextcloud recommandées
    fastcgi_param modHeadersAvailable true;
    fastcgi_param front_controller_active true;
    fastcgi_read_timeout 300s;
  }

  # Ressources statiques (cache)
  location ~ \.(?:css|js|mjs|woff2?|svg|gif|map)$ {
    try_files $uri /index.php$request_uri;
    expires 6M;
    access_log off;
  }

  location / {
    try_files $uri $uri/ /index.php$request_uri;
  }
}
